#!/usr/bin/env bashim
# vim: filetype=sh
set -Eeuo pipefail

FILE_INPUT="${1:?usage: set-ghostty-background /path/to/image}"
TARGET_FILE=$DOTFILES/ghostty/background.local

# resolve to absolute path
FILE_PATH="$(realpath -- "$FILE_INPUT")"

echo "background-image = $FILE_PATH" > "$TARGET_FILE"

reload_ghostty_macos() {
  osascript >/dev/null <<'APPLESCRIPT'
tell application "System Events"
  tell process "Ghostty"
    keystroke "," using {command down, shift down}
  end tell
end tell
APPLESCRIPT
}

if [[ "$(uname -s)" == "Darwin" ]]; then
  reload_ghostty_macos || true
else
  # kill -SIGUSR2 $(pgrep ghostty) >/dev/null 2>&1

  # Quietly notify Ghostty if it's running
  if command -v pkill >/dev/null 2>&1; then
    pkill -x -SIGUSR2 ghostty >/dev/null 2>&1 || true
  else
    if pids="$(pgrep -x ghostty)"; then
      # Deliberate word-splitting to pass multiple PIDs; '--' avoids option confusion
      # shellcheck disable=SC2086
      kill -s SIGUSR2 -- $pids >/dev/null 2>&1 || true
    fi
  fi
fi
